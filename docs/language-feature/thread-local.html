<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2017-10-29 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>language-feature &#x2013; ThreadLocal 学习</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                language-feature
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
          
                <div class="xleft">
        <span id="publishDate">Last Published: 2017-10-29</span>
                  &nbsp;| <span id="projectVersion">Version: 1.0-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="./" title="language-feature">language-feature</a>
            
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
           
                                <h5>Parent Project</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="java-learn">java-learn</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                        <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                    <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                 
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <h1>ThreadLocal &#x5b66;&#x4e60;</h1>

<blockquote>
<p>java.lang.ThreadLocal &#x7c7b;&#x63d0;&#x4f9b;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#x3002; &#x8fd9;&#x4e9b;&#x53d8;&#x91cf;&#x4e0e;&#x5176;&#x6b63;&#x5e38;&#x7684;&#x5bf9;&#x5e94;&#x65b9;&#x5f0f;&#x4e0d;&#x540c;&#xff0c;&#x56e0;&#x4e3a;&#x8bbf;&#x95ee;&#x4e00;&#x4e2a;&#x7684;&#x7ebf;&#x7a0b;&#xff08;&#x901a;&#x8fc7;&#x5176;get&#x6216;set&#x65b9;&#x6cd5;&#xff09;&#x5177;&#x6709;&#x81ea;&#x5df1;&#x7684;&#x72ec;&#x7acb;&#x521d;&#x59cb;&#x5316;&#x7684;&#x53d8;&#x91cf;&#x526f;&#x672c;&#x3002; ThreadLocal&#x5b9e;&#x4f8b;&#x901a;&#x5e38;&#x662f;&#x5e0c;&#x671b;&#x5c06;&#x72b6;&#x6001;&#x4e0e;&#x7ebf;&#x7a0b;&#xff08;&#x4f8b;&#x5982;&#xff0c;&#x7528;&#x6237;ID&#x6216;&#x4e8b;&#x52a1;ID&#xff09;&#x76f8;&#x5173;&#x8054;&#x7684;&#x7c7b;&#x4e2d;&#x7684;&#x79c1;&#x6709;&#x9759;&#x6001;&#x5b57;&#x6bb5;&#x3002;</p>
</blockquote>
<div class="section">
<h2><a name="a1_ThreadLocal"></a>1 &#x521b;&#x5efa;ThreadLocal</h2>

<blockquote>
<p>&#x521b;&#x5efa;&#x793a;&#x4f8b;(MyThreadLocal&#x4e3a;ThreadLocal&#x5b50;&#x7c7b;)&#xff1a;</p>
</blockquote>

<div class="source">
<div class="source">
<pre>private static MyThreadLocal threadLocal = new MyThreadLocal();
</pre></div></div>

<blockquote>
<p>&#x53ef;&#x4ee5;&#x770b;&#x5230;&#xff0c;&#x7a0b;&#x5e8f;&#x5b9e;&#x4f8b;&#x5316;&#x4e86;&#x4e00;&#x4e2a;&#x65b0;&#x7684;ThreadLocal&#x5bf9;&#x8c61;&#x3002; &#x8fd9;&#x53ea;&#x9700;&#x8981;&#x6bcf;&#x4e2a;&#x7ebf;&#x7a0b;&#x5b8c;&#x6210;&#x4e00;&#x6b21;&#x3002;&#x5373;&#x4f7f;&#x4e0d;&#x540c;&#x7684;&#x7ebf;&#x7a0b;&#x6267;&#x884c;&#x8bbf;&#x95ee;ThreadLococal&#x7684;&#x76f8;&#x540c;&#x4ee3;&#x7801;&#xff0c; &#x6bcf;&#x4e2a;&#x7ebf;&#x7a0b;&#x90fd;&#x5c06;&#x53ea;&#x770b;&#x5230;&#x5b83;&#x81ea;&#x5df1;&#x7684;ThreadLocal&#x5b9e;&#x4f8b;&#x3002; &#x5373;&#x4f7f;&#x4e24;&#x4e2a;&#x4e0d;&#x540c;&#x7684;&#x7ebf;&#x7a0b;&#x5728;&#x540c;&#x4e00;&#x4e2a;ThreadLocal&#x5bf9;&#x8c61;&#x4e0a;&#x8bbe;&#x7f6e;&#x4e0d;&#x540c;&#x7684;&#x503c;&#xff0c;&#x5b83;&#x4eec;&#x4e5f;&#x770b;&#x4e0d;&#x5230;&#x5bf9;&#x65b9;&#x7684;&#x503c;&#x3002;</p>
<p>&#x53ea;&#x8981;&#x7ebf;&#x7a0b;&#x5b58;&#x6d3b;&#x5e76;&#x4e14;ThreadLocal&#x5b9e;&#x4f8b;&#x53ef;&#x8bbf;&#x95ee;&#xff0c;&#x6bcf;&#x4e2a;&#x7ebf;&#x7a0b;&#x90fd;&#x4fdd;&#x5b58;&#x5bf9;&#x5176;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#x526f;&#x672c;&#x7684;&#x9690;&#x5f0f;&#x5f15;&#x7528;; &#x7ebf;&#x7a0b;&#x6d88;&#x5931;&#x540e;&#xff0c;&#x7ebf;&#x7a0b;&#x672c;&#x5730;&#x5b9e;&#x4f8b;&#x7684;&#x6240;&#x6709;&#x526f;&#x672c;&#x90fd;&#x5c06;&#x88ab;&#x5783;&#x573e;&#x6536;&#x96c6;&#xff08;&#x9664;&#x975e;&#x5b58;&#x5728;&#x5bf9;&#x8fd9;&#x4e9b;&#x526f;&#x672c;&#x7684;&#x5176;&#x4ed6;&#x5f15;&#x7528;&#xff09;&#x3002;</p>
</blockquote></div>
<div class="section">
<h2><a name="a2_ThreadLocal"></a>2 &#x8bbf;&#x95ee;ThreadLocal&#x5b9e;&#x4f8b;</h2>

<blockquote>
<p>ThreadLocal &#x63d0;&#x4f9b; get/set&#x65b9;&#x6cd5;&#x7528;&#x6765;&#x8bbf;&#x95ee;&#x5f53;&#x524d;&#x7ebf;&#x7a0b;&#x4e2d;&#x7684;&#x5c40;&#x90e8;&#x53d8;&#x91cf;:</p>
</blockquote>
<div class="section">
<h3><a name="a2.1_public_void_setT_value"></a>2.1 public void set(T value)&#x65b9;&#x6cd5;</h3>

<blockquote>
<p>&#x6e90;&#x7801;&#xff1a;</p>
</blockquote>

<div class="source">
<div class="source">
<pre>public void set(T value) {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null)
            map.set(this, value);
        else
            createMap(t, value);
}
</pre></div></div>

<blockquote>
<p>&#x5c06;&#x5f53;&#x524d;&#x7ebf;&#x7a0b;&#x7684;&#x6b64;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#x7684;&#x526f;&#x672c;&#x8bbe;&#x7f6e;&#x4e3a;&#x6307;&#x5b9a;&#x7684;&#x503c;&#x3002; &#x5927;&#x591a;&#x6570;&#x5b50;&#x7c7b;&#x5c06;&#x65e0;&#x9700;&#x91cd;&#x5199;&#x6b64;&#x65b9;&#x6cd5;&#xff0c;&#x4ec5;&#x4f9d;&#x9760;initialValue&#xff08;&#xff09;&#x65b9;&#x6cd5;&#x8bbe;&#x7f6e;&#x7ebf;&#x7a0b;&#x672c;&#x5730;&#x503c;&#x7684;&#x503c;&#x3002;</p>
<p>ThreadLocalMap&#x662f;ThreadLocal&#x7684;&#x9759;&#x6001;&#x5185;&#x90e8;&#x7c7b;&#xff0c;&#x662f;&#x4e00;&#x4e2a;&#x9002;&#x7528;&#x4e8e;&#x7ef4;&#x62a4;&#x7ebf;&#x7a0b;&#x672c;&#x5730;&#x503c;&#x7684;&#x81ea;&#x5b9a;&#x4e49;&#x54c8;&#x5e0c;&#x6620;&#x5c04;&#x3002; &#x6ca1;&#x6709;&#x4efb;&#x4f55;&#x64cd;&#x4f5c;&#x4f1a;&#x5bfc;&#x51fa;&#x5230;ThreadLocal&#x7c7b;&#x4e4b;&#x5916;&#x3002; &#x8be5;&#x7c7b;&#x662f;&#x79c1;&#x6709;&#x7684;&#xff0c;&#x53ea;&#x5141;&#x8bb8;&#x5728;Thread&#x7c7b;&#x4e2d;&#x58f0;&#x660e;&#x5b57;&#x6bb5;&#x3002; &#x4f7f;&#x7528;WeakReferences&#x7684;&#x952e;&#xff0c;&#x5e2e;&#x52a9;&#x5904;&#x7406;&#x975e;&#x5e38;&#x5927;&#x548c;&#x957f;&#x671f;&#x4f7f;&#x7528;&#x7684;&#x6563;&#x5217;&#x8868;&#x6761;&#x76ee;&#x3002; &#x4f46;&#x662f;&#xff0c;&#x7531;&#x4e8e;&#x4e0d;&#x4f7f;&#x7528;&#x5f15;&#x7528;&#x961f;&#x5217;&#xff0c;&#x56e0;&#x6b64;&#x53ea;&#x6709;&#x5728;&#x8868;&#x7a7a;&#x95f4;&#x4e0d;&#x8db3;&#x65f6;&#xff0c;&#x624d;&#x4f1a;&#x5220;&#x9664;&#x5df2;&#x4fdd;&#x7559;&#x7684;&#x6761;&#x76ee;&#x3002;&#x8be6;&#x60c5;&#x53c2;&#x8003;java.lang.ThreadLocal.ThreadLocalMap&#x3002;</p>
</blockquote></div>
<div class="section">
<h3><a name="a2.2_protected_T_initialValue"></a>2.2 protected T initialValue()&#x65b9;&#x6cd5;</h3>

<blockquote>
<p>&#x6e90;&#x7801;&#xff1a; </p>
</blockquote>

<div class="source">
<div class="source">
<pre>protected T initialValue() {
    return null;
}
</pre></div></div>

<blockquote>
<p>&#x8fd4;&#x56de;&#x6b64;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#x7684;&#x5f53;&#x524d;&#x7ebf;&#x7a0b;&#x7684;&#x201c;&#x521d;&#x59cb;&#x503c;&#x201d;&#x3002; &#x7ebf;&#x7a0b;&#x9996;&#x6b21;&#x4f7f;&#x7528;get()&#x65b9;&#x6cd5;&#x8bbf;&#x95ee;&#x53d8;&#x91cf;&#x65f6;&#xff0c;&#x5c06;&#x8c03;&#x7528;&#x6b64;&#x65b9;&#x6cd5;&#xff1b; &#x9664;&#x975e;&#x8be5;&#x7ebf;&#x7a0b;&#x5148;&#x524d;&#x8c03;&#x7528;&#x4e86;set(T)&#x65b9;&#x6cd5;&#xff0c;&#x5c06;&#x4e0d;&#x4f1a;&#x4e3a;&#x8be5;&#x7ebf;&#x7a0b;&#x8c03;&#x7528;initialValue&#x65b9;&#x6cd5;&#x3002; &#x901a;&#x5e38;&#xff0c;&#x6bcf;&#x4e2a;&#x7ebf;&#x7a0b;&#x6700;&#x591a;&#x8c03;&#x7528;&#x6b64;&#x65b9;&#x6cd5;&#x4e00;&#x6b21;&#xff0c;&#x4f46;&#x662f;&#x5728;&#x8c03;&#x7528;remove()&#x540e;&#x518d;&#x6b21;&#x8c03;&#x7528;get()&#x7684;&#x60c5;&#x51b5;&#x4e0b;&#xff0c;&#x53ef;&#x4ee5;&#x518d;&#x6b21;&#x8c03;&#x7528;&#x6b64;&#x65b9;&#x6cd5;&#x3002;</p>
<p>&#x8fd9;&#x4e2a;&#x5b9e;&#x73b0;&#x53ea;&#x662f;&#x8fd4;&#x56de;null; &#x5982;&#x679c;&#x7a0b;&#x5e8f;&#x5458;&#x5e0c;&#x671b;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#x5177;&#x6709;&#x9664;null&#x4e4b;&#x5916;&#x7684;&#x521d;&#x59cb;&#x503c;&#xff0c;&#x5219;ThreadLocal&#x5fc5;&#x987b;&#x88ab;&#x5b50;&#x7c7b;&#x5316;&#xff0c;&#x5e76;&#x4e14;&#x8986;&#x76d6;&#x8be5;&#x65b9;&#x6cd5;&#x3002; &#x901a;&#x5e38;&#xff0c;&#x4f7f;&#x7528;&#x533f;&#x540d;&#x5185;&#x90e8;&#x7c7b;&#x3002;</p>
</blockquote></div>
<div class="section">
<h3><a name="a2.3_public_T_get"></a>2.3 public T get()&#x65b9;&#x6cd5;</h3>

<blockquote>
<p>&#x6e90;&#x7801;&#xff1a;</p>
</blockquote>

<div class="source">
<div class="source">
<pre>public T get() {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null) {
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) {
            @SuppressWarnings(&quot;unchecked&quot;)
            T result = (T)e.value;
            return result;
        }
    }
    return setInitialValue();
}

private T setInitialValue() {
    T value = initialValue();  //&#x521d;&#x59cb;&#x5316; value
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null)
        map.set(this, value);
    else
        createMap(t, value);
    return value;
}
</pre></div></div>

<blockquote>
<p>&#x8fd4;&#x56de;&#x5f53;&#x524d;&#x7ebf;&#x7a0b;&#x7684;&#x6b64;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#x7684;&#x526f;&#x672c;&#x4e2d;&#x7684;&#x503c;&#x3002;&#x5982;&#x679c;&#x53d8;&#x91cf;&#x6ca1;&#x6709;&#x5f53;&#x524d;&#x7ebf;&#x7a0b;&#x7684;&#x503c;&#xff0c;&#x5219;&#x9996;&#x5148;&#x5c06;&#x5176;&#x521d;&#x59cb;&#x5316;&#x4e3a;&#x8c03;&#x7528;setInitialValue()&#x65b9;&#x6cd5;, &#x5e76;&#x5728;setInitialValue()&#x4e2d;&#x8c03;&#x7528;initialValue()&#x8fd4;&#x56de;&#x7684;&#x503c;&#x3002;</p>
</blockquote></div></div>
<div class="section">
<h2><a name="a3_ThreadLocal"></a>3 &#x521d;&#x59cb;&#x5316;ThreadLocal&#x503c;</h2>
<div class="section">
<h3><a name="a3.1_ThreadLocalinitialValue"></a>3.1 &#x901a;&#x8fc7;&#x5b50;&#x7c7b;&#x5316;ThreadLocal&#x5e76;&#x8986;&#x76d6;initialValue()&#x65b9;&#x6cd5;</h3>

<blockquote>
<p><a href="">&#x53c2;&#x8003;2.2</a></p>
</blockquote></div>
<div class="section">
<h3><a name="a3.2__withInitial_"></a>3.2 &#x901a;&#x8fc7; withInitial &#x65b9;&#x6cd5;</h3>

<blockquote>
<p>&#x521b;&#x5efa;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#x3002;&#x53d8;&#x91cf;&#x7684;&#x521d;&#x59cb;&#x503c;&#x901a;&#x8fc7;&#x8c03;&#x7528;Supplier&#x4e0a;&#x7684;get&#x65b9;&#x6cd5;&#x6765;&#x786e;&#x5b9a;&#x3002;</p>
<p>&#x6e90;&#x7801;&#xff1a;</p>
</blockquote>

<div class="source">
<div class="source">
<pre>public static &lt;S&gt; ThreadLocal&lt;S&gt; withInitial(Supplier&lt;? extends S&gt; supplier) {
    return new SuppliedThreadLocal&lt;&gt;(supplier);
}

static final class SuppliedThreadLocal&lt;T&gt; extends ThreadLocal&lt;T&gt; {

    private final Supplier&lt;? extends T&gt; supplier;

    SuppliedThreadLocal(Supplier&lt;? extends T&gt; supplier) {
        this.supplier = Objects.requireNonNull(supplier);
    }

    @Override
    protected T initialValue() {
        return supplier.get();
    }
}
</pre></div></div></div></div>
<div class="section">
<h2><a name="a4_ThreadLocal"></a>4 ThreadLocal&#x5b8c;&#x6574;&#x793a;&#x4f8b;</h2>

<div class="source">
<div class="source">
<pre>@Slf4j
public class ThreadA implements Runnable {

    // Atomic integer containing the next thread ID to be assigned
    private static final AtomicInteger nextId = new AtomicInteger(0);

    // Thread local variable containing each thread's ID
    private static final ThreadLocal&lt;Integer&gt; threadId = ThreadLocal.withInitial(() -&gt; nextId.getAndIncrement());

    // Returns the current thread's unique ID, assigning it if necessary
    public static int get() {
        return threadId.get();
    }

    @Override
    public void run() {
        log.info(&quot;-*--*--*--*- threadId : {}-*--*--*--*--&quot;,get());
    }

    public static void main(String[] args) {

        ExecutorService executorService = Executors.newFixedThreadPool(4);

        for (int ignored : IntStream.range(0,100).toArray()){
            executorService.submit(new ThreadA());
        }
    }
}
</pre></div></div></div>
<div class="section">
<h2><a name="a5_InheritableThreadLocal"></a>5 InheritableThreadLocal</h2>

<blockquote>
<p>&#x8be5;&#x7c7b;&#x6269;&#x5c55;&#x4e86; ThreadLocal&#xff0c;&#x4e3a;&#x5b50;&#x7ebf;&#x7a0b;&#x63d0;&#x4f9b;&#x4ece;&#x7236;&#x7ebf;&#x7a0b;&#x90a3;&#x91cc;&#x7ee7;&#x627f;&#x7684;&#x503c;&#xff1a; &#x5728;&#x521b;&#x5efa;&#x5b50;&#x7ebf;&#x7a0b;&#x65f6;&#xff0c;&#x5b50;&#x7ebf;&#x7a0b;&#x4f1a;&#x63a5;&#x6536;&#x6240;&#x6709;&#x53ef;&#x7ee7;&#x627f;&#x7684;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#x7684;&#x521d;&#x59cb;&#x503c;&#xff0c;&#x4ee5;&#x83b7;&#x5f97;&#x7236;&#x7ebf;&#x7a0b;&#x6240;&#x5177;&#x6709;&#x7684;&#x503c;&#x3002; &#x901a;&#x5e38;&#xff0c;&#x5b50;&#x7ebf;&#x7a0b;&#x7684;&#x503c;&#x4e0e;&#x7236;&#x7ebf;&#x7a0b;&#x7684;&#x503c;&#x662f;&#x4e00;&#x81f4;&#x7684;&#xff1b; &#x4f46;&#x662f;&#xff0c;&#x901a;&#x8fc7;&#x91cd;&#x5199;&#x8fd9;&#x4e2a;&#x7c7b;&#x4e2d;&#x7684; childValue &#x65b9;&#x6cd5;&#xff0c;&#x5b50;&#x7ebf;&#x7a0b;&#x7684;&#x503c;&#x53ef;&#x4ee5;&#x4f5c;&#x4e3a;&#x7236;&#x7ebf;&#x7a0b;&#x503c;&#x7684;&#x4e00;&#x4e2a;&#x4efb;&#x610f;&#x51fd;&#x6570;&#x3002;</p>
<p>&#x5f53;&#x5fc5;&#x987b;&#x5c06;&#x53d8;&#x91cf;&#xff08;&#x5982;&#x7528;&#x6237; ID &#x548c; &#x4e8b;&#x52a1; ID&#xff09;&#x4e2d;&#x7ef4;&#x62a4;&#x7684;&#x6bcf;&#x7ebf;&#x7a0b;&#x5c5e;&#x6027;&#xff08;per-thread-attribute&#xff09;&#x81ea;&#x52a8;&#x4f20;&#x9001;&#x7ed9;&#x521b;&#x5efa;&#x7684;&#x6240;&#x6709;&#x5b50;&#x7ebf;&#x7a0b;&#x65f6;&#xff0c; &#x5e94;&#x5c3d;&#x53ef;&#x80fd;&#x5730;&#x91c7;&#x7528;&#x53ef;&#x7ee7;&#x627f;&#x7684;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#xff0c;&#x800c;&#x4e0d;&#x662f;&#x91c7;&#x7528;&#x666e;&#x901a;&#x7684;&#x7ebf;&#x7a0b;&#x5c40;&#x90e8;&#x53d8;&#x91cf;&#x3002;</p>
</blockquote></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2017.
          All rights reserved.    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
