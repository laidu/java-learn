<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-03-20 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>dev-ops &#x2013; </title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                dev-ops
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
          
                <div class="xleft">
        <span id="publishDate">Last Published: 2018-03-20</span>
                  &nbsp;| <span id="projectVersion">Version: 1.0-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="./" title="dev-ops">dev-ops</a>
            
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
           
                                <h5>Parent Project</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="java-learn">java-learn</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                        <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                      <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                 
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <p># dstat &#x547d;&#x4ee4;&#x4f7f;&#x7528;</p>
<div class="section">
<h2><a name="a1_"></a>1 &#x7b80;&#x4ecb;</h2>

<blockquote>
<p><a class="externalLink" href="http://www.haproxy.org/">HAProxy</a> &#x662f;&#x4e00;&#x4e2a;&#x4f7f;&#x7528;C&#x8bed;&#x8a00;&#x7f16;&#x5199;&#x7684;&#x81ea;&#x7531;&#x53ca;&#x5f00;&#x653e;&#x6e90;&#x4ee3;&#x7801;&#x8f6f;&#x4ef6;&#xff0c;&#x5176;&#x63d0;&#x4f9b;&#x9ad8;&#x53ef;&#x7528;&#x6027;&#x3001;&#x8d1f;&#x8f7d;&#x5747;&#x8861;&#xff0c;&#x4ee5;&#x53ca;&#x57fa;&#x4e8e;TCP&#x548c;HTTP&#x7684;&#x5e94;&#x7528;&#x7a0b;&#x5e8f;&#x4ee3;&#x7406;&#x3002; * &#x63d0;&#x4f9b;&#x9ad8;&#x53ef;&#x7528;&#x6027;&#x3001;&#x8d1f;&#x8f7d;&#x5747;&#x8861;&#x4ee5;&#x53ca;&#x57fa;&#x4e8e;TCP&#x548c;HTTP&#x5e94;&#x7528;&#x7684;&#x4ee3;&#x7406;&#xff0c;&#x652f;&#x6301;&#x865a;&#x62df;&#x4e3b;&#x673a;&#xff0c;&#x5b83;&#x662f;&#x514d;&#x8d39;&#x3001;&#x5feb;&#x901f;&#x5e76;&#x4e14;&#x53ef;&#x9760;&#x7684;&#x4e00;&#x79cd;&#x89e3;&#x51b3;&#x65b9;&#x6848;&#x3002;&#x6839;&#x636e;&#x5b98;&#x65b9;&#x6570;&#x636e;&#xff0c;&#x5176;&#x6700;&#x9ad8;&#x6781;&#x9650;&#x652f;&#x6301;10G&#x7684;&#x5e76;&#x53d1;&#x3002; * HAProxy&#x7279;&#x522b;&#x9002;&#x7528;&#x4e8e;&#x90a3;&#x4e9b;&#x8d1f;&#x8f7d;&#x7279;&#x5927;&#x7684;web&#x7ad9;&#x70b9;&#xff0c;&#x8fd9;&#x4e9b;&#x7ad9;&#x70b9;&#x901a;&#x5e38;&#x53c8;&#x9700;&#x8981;&#x4f1a;&#x8bdd;&#x4fdd;&#x6301;&#x6216;&#x4e03;&#x5c42;&#x5904;&#x7406;&#x3002;HAProxy&#x8fd0;&#x884c;&#x5728;&#x5f53;&#x524d;&#x7684;&#x786c;&#x4ef6;&#x4e0a;&#xff0c;&#x5b8c;&#x5168;&#x53ef;&#x4ee5;&#x652f;&#x6301;&#x6570;&#x4ee5;&#x4e07;&#x8ba1;&#x7684;&#x5e76;&#x53d1;&#x8fde;&#x63a5;&#x3002;&#x5e76;&#x4e14;&#x5b83;&#x7684;&#x8fd0;&#x884c;&#x6a21;&#x5f0f;&#x4f7f;&#x5f97;&#x5b83;&#x53ef;&#x4ee5;&#x5f88;&#x7b80;&#x5355;&#x5b89;&#x5168;&#x7684;&#x6574;&#x5408;&#x8fdb;&#x60a8;&#x5f53;&#x524d;&#x7684;&#x67b6;&#x6784;&#x4e2d;&#xff0c; &#x540c;&#x65f6;&#x53ef;&#x4ee5;&#x4fdd;&#x62a4;&#x4f60;&#x7684;web&#x670d;&#x52a1;&#x5668;&#x4e0d;&#x88ab;&#x66b4;&#x9732;&#x5230;&#x7f51;&#x7edc;&#x4e0a;&#x3002;<br /> * HAProxy&#x5b9e;&#x73b0;&#x4e86;&#x4e00;&#x79cd;&#x4e8b;&#x4ef6;&#x9a71;&#x52a8;, &#x5355;&#x4e00;&#x8fdb;&#x7a0b;&#x6a21;&#x578b;&#xff0c;&#x6b64;&#x6a21;&#x578b;&#x652f;&#x6301;&#x975e;&#x5e38;&#x5927;&#x7684;&#x5e76;&#x53d1;&#x8fde;&#x63a5;&#x6570;&#x3002;&#x591a;&#x8fdb;&#x7a0b;&#x6216;&#x591a;&#x7ebf;&#x7a0b;&#x6a21;&#x578b;&#x53d7;&#x5185;&#x5b58;&#x9650;&#x5236; &#x3001;&#x7cfb;&#x7edf;&#x8c03;&#x5ea6;&#x5668;&#x9650;&#x5236;&#x4ee5;&#x53ca;&#x65e0;&#x5904;&#x4e0d;&#x5728;&#x7684;&#x9501;&#x9650;&#x5236;&#xff0c;&#x5f88;&#x5c11;&#x80fd;&#x5904;&#x7406;&#x6570;&#x5343;&#x5e76;&#x53d1;&#x8fde;&#x63a5;&#x3002;&#x4e8b;&#x4ef6;&#x9a71;&#x52a8;&#x6a21;&#x578b;&#x56e0;&#x4e3a;&#x5728;&#x6709;&#x66f4;&#x597d;&#x7684;&#x8d44;&#x6e90;&#x548c;&#x65f6;&#x95f4;&#x7ba1;&#x7406;&#x7684;&#x7528;&#x6237;&#x7a7a;&#x95f4;(User-Space) &#x5b9e;&#x73b0;&#x6240;&#x6709;&#x8fd9;&#x4e9b;&#x4efb;&#x52a1;&#xff0c;&#x6240;&#x4ee5;&#x6ca1;&#x6709;&#x8fd9;&#x4e9b;&#x95ee;&#x9898;&#x3002;&#x6b64;&#x6a21;&#x578b;&#x7684;&#x5f0a;&#x7aef;&#x662f;&#xff0c;&#x5728;&#x591a;&#x6838;&#x7cfb;&#x7edf;&#x4e0a;&#xff0c;&#x8fd9;&#x4e9b;&#x7a0b;&#x5e8f;&#x901a;&#x5e38;&#x6269;&#x5c55;&#x6027;&#x8f83;&#x5dee;&#x3002;&#x8fd9;&#x5c31;&#x662f;&#x4e3a;&#x4ec0;&#x4e48;&#x4ed6;&#x4eec;&#x5fc5;&#x987b;&#x8fdb;&#x884c;&#x4f18;&#x5316;&#x4ee5; &#x4f7f;&#x6bcf;&#x4e2a;CPU&#x65f6;&#x95f4;&#x7247;(Cycle)&#x505a;&#x66f4;&#x591a;&#x7684;&#x5de5;&#x4f5c;&#x3002; * Haproxy &#x5e76;&#x4e0d;&#x662f; Http &#x670d;&#x52a1;&#x5668;&#x3002;Nginx&#xff0c;ApacheProxy&#xff0c;lighttpd&#xff0c;Cheroke &#x7b49;&#x5e26;&#x53cd;&#x5411;&#x4ee3;&#x7406;&#x5747;&#x8861;&#x8d1f;&#x8f7d;&#x7684;&#x4ea7;&#x54c1;&#xff0c;&#x90fd;&#x6e05;&#x4e00;&#x8272;&#x662f; WEB &#x670d;&#x52a1;&#x5668;&#x3002;&#x7b80;&#x5355;&#x8bf4;&#xff0c;&#x5c31;&#x662f;&#x4ed6;&#x4eec;&#x80fd;&#x81ea;&#x4e2a;&#x513f;&#x63d0;&#x4f9b;&#x9759;&#x6001;(html,jpg,gif..)&#x6216;&#x52a8;&#x6001;(php,cgi..)&#x6587;&#x4ef6;&#x7684;&#x4f20;&#x8f93;&#x4ee5;&#x53ca;&#x5904;&#x7406;&#x3002;&#x800c;Haproxy &#x4ec5;&#x4ec5;&#xff0c;&#x800c;&#x4e14;&#x4e13;&#x95e8;&#x662f;&#x4e00;&#x6b3e;&#x7684;&#x7528;&#x4e8e;&#x5747;&#x8861;&#x8d1f;&#x8f7d;&#x7684;&#x5e94;&#x7528;&#x4ee3;&#x7406;&#x3002;&#x5176;&#x81ea;&#x8eab;&#x5e76;&#x4e0d;&#x80fd;&#x63d0;&#x4f9b;http&#x670d;&#x52a1;&#x3002; </p>
</blockquote></div>
<div class="section">
<h2><a name="a2_"></a>2 &#x529f;&#x80fd;</h2></div>
<div class="section">
<h2><a name="a3_"></a>3 &#x5b89;&#x88c5;</h2>
<div class="section">
<h3><a name="a"></a>&#x914d;&#x7f6e;</h3>

<div class="source">
<div class="source">
<pre>global               #&#x5168;&#x5c40;&#x8bbe;&#x7f6e;
    log 127.0.0.1   local0   #&#x65e5;&#x5fd7;&#x8f93;&#x51fa;&#x914d;&#x7f6e;&#xff0c;&#x6240;&#x6709;&#x65e5;&#x5fd7;&#x90fd;&#x8bb0;&#x5f55;&#x5728;&#x672c;&#x673a;&#xff0c;&#x901a;&#x8fc7;local0&#x8f93;&#x51fa;
    #log loghost    local0 info
    maxconn 4096             #&#x6700;&#x5927;&#x8fde;&#x63a5;&#x6570;
    chroot /usr/local/haproxy
    uid 99                   #&#x6240;&#x5c5e;&#x8fd0;&#x884c;&#x7684;&#x7528;&#x6237;uid
    gid 99                   #&#x6240;&#x5c5e;&#x8fd0;&#x884c;&#x7684;&#x7528;&#x6237;&#x7ec4;
    group haproxy            #&#x7528;&#x6237;&#x7ec4;
    daemon                   #&#x540e;&#x53f0;&#x8fd0;&#x884c;haproxy
    nbproc 1                 #&#x542f;&#x52a8;1&#x4e2a;haproxy&#x5b9e;&#x4f8b;
    pidfile /usr/local/haproxy/haproxy.pid  #&#x5c06;&#x6240;&#x6709;&#x8fdb;&#x7a0b;PID&#x5199;&#x5165;pid&#x6587;&#x4ef6;
    #debug
    #quiet
 
defaults             #&#x9ed8;&#x8ba4;&#x8bbe;&#x7f6e;
    #log    global
    log     127.0.0.1       local3      #&#x65e5;&#x5fd7;&#x6587;&#x4ef6;&#x7684;&#x8f93;&#x51fa;&#x5b9a;&#x5411;
 
    #&#x9ed8;&#x8ba4;&#x7684;&#x6a21;&#x5f0f;:tcp|http|health
    mode   http         #&#x6240;&#x5904;&#x7406;&#x7684;&#x7c7b;&#x522b;,&#x9ed8;&#x8ba4;&#x91c7;&#x7528;http&#x6a21;&#x5f0f;
 
    option  httplog      #&#x65e5;&#x5fd7;&#x7c7b;&#x522b;,&#x91c7;&#x7528;http&#x65e5;&#x5fd7;&#x683c;&#x5f0f;`
    option  dontlognull
    option  forwardfor   #&#x5c06;&#x5ba2;&#x6237;&#x7aef;&#x771f;&#x5b9e;ip&#x52a0;&#x5230;HTTP Header&#x4e2d;&#x4f9b;&#x540e;&#x7aef;&#x670d;&#x52a1;&#x5668;&#x8bfb;&#x53d6;
    option  retries 3    #&#x4e09;&#x6b21;&#x8fde;&#x63a5;&#x5931;&#x8d25;&#x5219;&#x8ba4;&#x8bc1;&#x670d;&#x52a1;&#x5668;&#x4e0d;&#x53ef;&#x7528;
    option  httpclose    #&#x6bcf;&#x6b21;&#x8bf7;&#x6c42;&#x5b8c;&#x6bd5;&#x540e;&#x4e3b;&#x52a8;&#x5173;&#x95ed;http&#x901a;&#x9053;,haproxy&#x4e0d;&#x652f;&#x6301;keep-alive,&#x53ea;&gt;&#x80fd;&#x6a21;&#x62df;&#x8fd9;&#x79cd;&#x6a21;&#x5f0f;&#x7684;&#x5b9e;&#x73b0;
    retries 3            #3&#x6b21;&#x8fde;&#x63a5;&#x5931;&#x8d25;&#x5c31;&#x8ba4;&#x4e3a;&#x670d;&#x52a1;&#x5668;&#x4e0d;&#x53ef;&#x7528;&#xff0c;&#x4e3b;&#x8981;&#x901a;&#x8fc7;&#x540e;&#x9762;&#x7684;check&#x68c0;&#x67e5;
    option  redispatch   #&#x5f53;serverid&#x5bf9;&#x5e94;&#x7684;&#x670d;&#x52a1;&#x5668;&#x6302;&#x6389;&#x540e;&#xff0c;&#x5f3a;&#x5236;&#x5b9a;&#x5411;&#x5230;&#x5176;&#x4ed6;&#x5065;&#x5eb7;&#x670d;&#x52a1;&#x5668;
    option  abortonclose #&#x5f53;&#x670d;&#x52a1;&#x5668;&#x8d1f;&#x8f7d;&#x5f88;&#x9ad8;&#x65f6;&#xff0c;&#x81ea;&#x52a8;&#x7ed3;&#x675f;&#x6389;&#x5f53;&#x524d;&#x961f;&#x5217;&#x4e2d;&#x5904;&#x7406;&#x6bd4;&#x8f83;&#x4e45;&#x7684;&#x94fe;&#x63a5;
    maxconn 2000         #&#x9ed8;&#x8ba4;&#x6700;&#x5927;&#x8fde;&#x63a5;&#x6570;
 
    timeout connect 5000  #&#x8fde;&#x63a5;&#x8d85;&#x65f6;&#x65f6;&#x95f4;
    timeout client  50000 #&#x5ba2;&#x6237;&#x7aef;&#x8fde;&#x63a5;&#x8d85;&#x65f6;&#x65f6;&#x95f4;
    timeout server  50000 #&#x670d;&#x52a1;&#x5668;&#x7aef;&#x8fde;&#x63a5;&#x8d85;&#x65f6;&#x65f6;&#x95f4;
 
    stats   enable
    stats   uri /haproxy-stats   #haproxy&#x76d1;&#x63a7;&#x9875;&#x9762;&#x7684;&#x8bbf;&#x95ee;&#x5730;&#x5740;
    stats   auth test:test123    #&#x8bbe;&#x7f6e;&#x76d1;&#x63a7;&#x9875;&#x9762;&#x7684;&#x7528;&#x6237;&#x548c;&#x5bc6;&#x7801;
    stats   hide-version         #&#x9690;&#x85cf;&#x7edf;&#x8ba1;&#x9875;&#x9762;&#x7684;HAproxy&#x7248;&#x672c;&#x4fe1;&#x606f;
 
frontend http-in              #&#x524d;&#x53f0;
    bind    *:81
    mode    http
    option  httplog
    log     global
    default_backend htmpool   #&#x9759;&#x6001;&#x670d;&#x52a1;&#x5668;&#x6c60;
 
backend htmpool               #&#x540e;&#x53f0;
    balance leastconn         #&#x8d1f;&#x8f7d;&#x5747;&#x8861;&#x7b97;&#x6cd5;
    option  httpchk HEAD /index.html HTTP/1.0    #&#x5065;&#x5eb7;&#x68c0;&#x67e5;
    server  web1 192.168.2.10:80 cookie 1 weight 5 check inter 2000 rise 2 fall 3
    server  web2 192.168.2.11:80 cookie 2 weight 3 check inter 2000 rise 2 fall 3
    # web1/web2:&#x81ea;&#x5b9a;&#x4e49;&#x670d;&#x52a1;&#x5668;&#x522b;&#x540d;
    # 192.168.2.10:80:&#x670d;&#x52a1;&#x5668;IP:Port
    # cookie 1/2:&#x8868;&#x793a;serverid
    # weight: &#x670d;&#x52a1;&#x5668;&#x6743;&#x91cd;&#xff0c;&#x6570;&#x5b57;&#x8d8a;&#x5927;&#x5206;&#x914d;&#x5230;&#x7684;&#x8bf7;&#x6c42;&#x6570;&#x8d8a;&#x9ad8;
    # check: &#x63a5;&#x53d7;&#x5b9a;&#x65f6;&#x5065;&#x5eb7;&#x68c0;&#x67e5; 
    # inter 2000: &#x68c0;&#x67e5;&#x9891;&#x7387;
    # rise 2: &#x4e24;&#x6b21;&#x68c0;&#x6d4b;&#x6b63;&#x786e;&#x8ba4;&#x4e3a;&#x670d;&#x52a1;&#x5668;&#x53ef;&#x7528;
    # fall 3: &#x4e09;&#x6b21;&#x5931;&#x8d25;&#x8ba4;&#x4e3a;&#x670d;&#x52a1;&#x5668;&#x4e0d;&#x53ef;&#x7528;
 
listen w.gdu.me 0.0.0.0:80
    option  httpchk GET /index.html
    server  s1 192.168.2.10:80 weight 3 check
    server  s3 192.168.2.11:80 weight 3 check
 
# Haproxy&#x7edf;&#x8ba1;&#x9875;&#x9762;
# --------------------------------------------------------------------------------------------
listen haproxy_stats
    bind 0.0.0.0:1080  #&#x4fa6;&#x542c;IP:Port
    mode http
    log  127.0.0.1 local 0 err #err|warning|info|debug]
    stats refresh 30s
    stats uri /haproxy-stats
    stats realm Haproxy\ Statistics
    stats auth admin:admin
    stats auth test:test
    stats hide-version
    stats admin if TRUE  #&#x624b;&#x5de5;&#x542f;&#x7528;/&#x7981;&#x7528;&#x540e;&#x7aef;&#x670d;&#x52a1;&#x5668;
 
 
# &#x7f51;&#x7ad9;&#x68c0;&#x6d4b;listen&#x914d;&#x7f6e;
# --------------------------------------------------------------------------------------------
listen site_status
    bind 0.0.0.0:1081
    mode http
    log  127.0.0.1 local0 err
 
    #&#x7f51;&#x7ad9;&#x5065;&#x5eb7;&#x68c0;&#x67e5;URI&#xff0c;&#x7528;&#x6765;&#x68c0;&#x6d4b;Haproxy&#x7ba1;&#x7406;&#x7684;&#x7f51;&#x7ad9;&#x662f;&#x5426;&#x53ef;&#x80fd;&#xff0c;&#x6b63;&#x5e38;&#x8fd4;&#x56de;200&#x3001;&#x5f02;&#x5e38;&#x8fd4;&#x56de;500
    monitor-uri /site_status
 
    #&#x5b9a;&#x4e49;&#x7f51;&#x7ad9;down&#x65f6;&#x7684;&#x7b56;&#x7565;
    #&#x5f53;backend&#x4e2d;&#x7684;&#x6709;&#x6548;&#x670d;&#x52a1;&#x5668;&#x6570;&lt;1&#x65f6;&#xff0c;&#x8fd4;&#x56de;true
    acl site_dead nbsrv(denali_server) lt 1
    acl site_dead nbsrv(tm_server) lt 1
    acl site_dead nbsrv(mms_server) lt 1
 
    #&#x5f53;&#x6ee1;&#x8db3;&#x7b56;&#x7565;&#x7684;&#x65f6;&#x5019;&#x8fd4;&#x56de;http-500&#xff0c;&#x5426;&#x5219;&#x8fd4;&#x56de;http-200
    monitor fail if site_dead
 
    #&#x58f0;&#x540d;&#x4e00;&#x4e2a;&#x76d1;&#x6d4b;&#x8bf7;&#x6c42;&#x7684;&#x6765;&#x6e90;&#x7f51;&#x7edc;
    monitor-net 192.168.0.252/31
 
 
# https&#x7684;&#x914d;&#x7f6e;&#x65b9;&#x6cd5;
# --------------------------------------------------------------------------------------------
listen login_https_server
    bind 0.0.0.0:443   #&#x7ed1;&#x5b9a;HTTPS&#x7684;443&#x7aef;&#x53e3;
    mode tcp           #https&#x5fc5;&#x987b;&#x4f7f;&#x7528;tcp&#x6a21;&#x5f0f;
    log global
    balance roundrobin
    option httpchk GET /member/login.jhtml HTTP/1.1\r\nHost:login.daily.taobao.net
    #&#x56de;&#x9001;&#x7ed9;server&#x7684;&#x7aef;&#x53e3;&#x4e5f;&#x5fc5;&#x987b;&#x662f;443
    server vm94f.sqa 192.168.212.94:443 check port 80 inter 6000 rise 3 fall 3
    server v215120.sqa 192.168.215.120:443 check port 80 inter 6000 rise 3 fall 3
 
 
# frontend&#x914d;&#x7f6e;
# --------------------------------------------------------------------------------------------
frontend http_80_in
    bind 0.0.0.0:80   #&#x76d1;&#x542c;&#x7aef;&#x53e3;
    mode http         #http&#x7684;7&#x5c42;&#x6a21;&#x5f0f;
    log global        #&#x4f7f;&#x7528;&#x5168;&#x5c40;&#x7684;&#x65e5;&#x5fd7;&#x914d;&#x7f6e;
    option httplog    #&#x542f;&#x7528;http&#x7684;log
    option httpclose  #&#x6bcf;&#x6b21;&#x8bf7;&#x6c42;&#x5b8c;&#x6bd5;&#x540e;&#x4e3b;&#x52a8;&#x5173;&#x95ed;http&#x901a;&#x9053;,HA-Proxy&#x4e0d;&#x652f;&#x6301;keep-alive&#x6a21;&#x5f0f;
    option forwardfor ##&#x5982;&#x679c;&#x540e;&#x7aef;&#x670d;&#x52a1;&#x5668;&#x9700;&#x8981;&#x83b7;&#x5f97;&#x5ba2;&#x6237;&#x7aef;&#x7684;&#x771f;&#x5b9e;IP&#x9700;&#x8981;&#x914d;&#x7f6e;&#x6b21;&#x53c2;&#x6570;,&#x5c06;&#x53ef;&#x4ee5;&#x4ece;Http Header&#x4e2d;&#x83b7;&#x5f97;&#x5ba2;&#x6237;&#x7aef;IP
 
    #HAProxy&#x7684;&#x65e5;&#x5fd7;&#x8bb0;&#x5f55;&#x5185;&#x5bb9;&#x914d;&#x7f6e;
    capture request header Host len 40              # &#x8bf7;&#x6c42;&#x4e2d;&#x7684;&#x4e3b;&#x673a;&#x540d;
    capture request header Content-Length len 10    # &#x8bf7;&#x6c42;&#x4e2d;&#x7684;&#x5185;&#x5bb9;&#x957f;&#x5ea6;
    capture request header Referer len 200          # &#x8bf7;&#x6c42;&#x4e2d;&#x7684;&#x5f15;&#x7528;&#x5730;&#x5740;
    capture responses header Server len 40           # &#x54cd;&#x5e94;&#x4e2d;&#x7684;server name
    capture responses header Content-Length len 10   # &#x54cd;&#x5e94;&#x4e2d;&#x7684;&#x5185;&#x5bb9;&#x957f;&#x5ea6;(&#x53ef;&#x914d;&#x5408;option logasap&#x4f7f;&#x7528;)
    capture responses header Cache-Control len 8     # &#x54cd;&#x5e94;&#x4e2d;&#x7684;cache&#x63a7;&#x5236;
    capture responses header Location len 20         # &#x54cd;&#x5e94;&#x4e2d;&#x7684;&#x91cd;&#x5b9a;&#x5411;&#x5730;&#x5740;
 
 
    #ACL&#x7b56;&#x7565;&#x89c4;&#x5219;&#x5b9a;&#x4e49;
    #-------------------------------------------------
    #&#x5982;&#x679c;&#x8bf7;&#x6c42;&#x7684;&#x57df;&#x540d;&#x6ee1;&#x8db3;&#x6b63;&#x5219;&#x8868;&#x8fbe;&#x5f0f;&#x8fd4;&#x56de;true(-i:&#x5ffd;&#x7565;&#x5927;&#x5c0f;&#x5199;)
    acl denali_policy hdr_reg(host) -i ^(www.gemini.taobao.net|my.gemini.taobao.net|auction1.gemini.taobao.net)$
 
    #&#x5982;&#x679c;&#x8bf7;&#x6c42;&#x57df;&#x540d;&#x6ee1;&#x8db3;trade.gemini.taobao.net&#x8fd4;&#x56de;true
    acl tm_policy hdr_dom(host) -i trade.gemini.taobao.net
 
    #&#x5728;&#x8bf7;&#x6c42;url&#x4e2d;&#x5305;&#x542b;sip_apiname=,&#x5219;&#x6b64;&#x63a7;&#x5236;&#x7b56;&#x7565;&#x8fd4;&#x56de;true,&#x5426;&#x5219;&#x4e3a;false
    acl invalid_req url_sub -i sip_apiname=
 
    #&#x5728;&#x8bf7;&#x6c42;url&#x4e2d;&#x5b58;&#x5728;timetask&#x4f5c;&#x4e3a;&#x90e8;&#x5206;&#x5730;&#x5740;&#x8def;&#x5f84;,&#x5219;&#x6b64;&#x63a7;&#x5236;&#x7b56;&#x7565;&#x8fd4;&#x56de;true,&#x5426;&#x5219;&#x8fd4;&#x56de;false
    acl timetask_req url_dir -i timetask
 
    #&#x5f53;&#x8bf7;&#x6c42;&#x7684;header&#x4e2d;Content-length&#x7b49;&#x4e8e;0&#x65f6;&#x8fd4;&#x56de;true
    acl missing_cl hdr_cnt(Content-length) eq 0
 
 
    #ACL&#x7b56;&#x7565;&#x5339;&#x914d;&#x76f8;&#x5e94;
    #-------------------------------------------------
    #&#x5f53;&#x8bf7;&#x6c42;&#x4e2d;header&#x4e2d;Content-length&#x7b49;&#x4e8e;0&#x963b;&#x6b62;&#x8bf7;&#x6c42;&#x8fd4;&#x56de;403
    #block&#x8868;&#x793a;&#x963b;&#x6b62;&#x8bf7;&#x6c42;,&#x8fd4;&#x56de;403&#x9519;&#x8bef;
    block if missing_cl
 
    #&#x5982;&#x679c;&#x4e0d;&#x6ee1;&#x8db3;&#x7b56;&#x7565;invalid_req,&#x6216;&#x8005;&#x6ee1;&#x8db3;&#x7b56;&#x7565;timetask_req,&#x5219;&#x963b;&#x6b62;&#x8bf7;&#x6c42;
    block if !invalid_req || timetask_req
 
    #&#x5f53;&#x6ee1;&#x8db3;denali_policy&#x7684;&#x7b56;&#x7565;&#x65f6;&#x4f7f;&#x7528;denali_server&#x7684;backend
    use_backend denali_server if denali_policy
 
    #&#x5f53;&#x6ee1;&#x8db3;tm_policy&#x7684;&#x7b56;&#x7565;&#x65f6;&#x4f7f;&#x7528;tm_server&#x7684;backend
    use_backend tm_server if tm_policy
 
    #reqisetbe&#x5173;&#x952e;&#x5b57;&#x5b9a;&#x4e49;,&#x6839;&#x636e;&#x5b9a;&#x4e49;&#x7684;&#x5173;&#x952e;&#x5b57;&#x9009;&#x62e9;backend
    reqisetbe ^Host:\ img           dynamic
    reqisetbe ^[^\ ]*\ /(img|css)/  dynamic
    reqisetbe ^[^\ ]*\ /admin/stats stats
 
    #&#x4ee5;&#x4e0a;&#x90fd;&#x4e0d;&#x6ee1;&#x8db3;&#x7684;&#x65f6;&#x5019;&#x4f7f;&#x7528;&#x9ed8;&#x8ba4;mms_server&#x7684;backend
    default_backend mms_server
 
    #HAProxy&#x9519;&#x8bef;&#x9875;&#x9762;&#x8bbe;&#x7f6e;
    errorfile 400 /home/admin/haproxy/errorfiles/400.http
    errorfile 403 /home/admin/haproxy/errorfiles/403.http
    errorfile 408 /home/admin/haproxy/errorfiles/408.http
    errorfile 500 /home/admin/haproxy/errorfiles/500.http
    errorfile 502 /home/admin/haproxy/errorfiles/502.http
    errorfile 503 /home/admin/haproxy/errorfiles/503.http
    errorfile 504 /home/admin/haproxy/errorfiles/504.http
 
 
# backend&#x7684;&#x8bbe;&#x7f6e;
# --------------------------------------------------------------------------------------------
backend mms_server
    mode http           #http&#x7684;7&#x5c42;&#x6a21;&#x5f0f;
    balance roundrobin  #&#x8d1f;&#x8f7d;&#x5747;&#x8861;&#x7684;&#x65b9;&#x5f0f;,roundrobin&#x5e73;&#x5747;&#x65b9;&#x5f0f;
    cookie SERVERID     #&#x5141;&#x8bb8;&#x63d2;&#x5165;serverid&#x5230;cookie&#x4e2d;,serverid&#x540e;&#x9762;&#x53ef;&#x4ee5;&#x5b9a;&#x4e49;
     
    #&#x5fc3;&#x8df3;&#x68c0;&#x6d4b;&#x7684;URL,HTTP/1.1&#xa5;r&#xa5;nHost:XXXX,&#x6307;&#x5b9a;&#x4e86;&#x5fc3;&#x8df3;&#x68c0;&#x6d4b;HTTP&#x7684;&#x7248;&#x672c;,XXX&#x4e3a;&#x68c0;&#x6d4b;&#x65f6;&#x8bf7;&#x6c42;
    #&#x670d;&#x52a1;&#x5668;&#x7684;request&#x4e2d;&#x7684;&#x57df;&#x540d;&#x662f;&#x4ec0;&#x4e48;,&#x8fd9;&#x4e2a;&#x5728;&#x5e94;&#x7528;&#x7684;&#x68c0;&#x6d4b;URL&#x5bf9;&#x5e94;&#x7684;&#x529f;&#x80fd;&#x6709;&#x5bf9;&#x57df;&#x540d;&#x4f9d;&#x8d56;&#x7684;&#x8bdd;&#x9700;&#x8981;&#x8bbe;&#x7f6e;
    option httpchk GET /member/login.jhtml HTTP/1.1\r\nHost:member1.gemini.taobao.net
     
    #&#x670d;&#x52a1;&#x5668;&#x5b9a;&#x4e49;,cookie 1&#x8868;&#x793a;serverid&#x4e3a;1,check inter 1500 &#x662f;&#x68c0;&#x6d4b;&#x5fc3;&#x8df3;&#x9891;&#x7387;
    #rise 3&#x662f;3&#x6b21;&#x6b63;&#x786e;&#x8ba4;&#x4e3a;&#x670d;&#x52a1;&#x5668;&#x53ef;&#x7528;,fall 3&#x662f;3&#x6b21;&#x5931;&#x8d25;&#x8ba4;&#x4e3a;&#x670d;&#x52a1;&#x5668;&#x4e0d;&#x53ef;&#x7528;,weight&#x4ee3;&#x8868;&#x6743;&#x91cd;
    server mms1 10.1.5.134:80 cookie 1 check inter 1500 rise 3 fall 3 weight 1
    server mms2 10.1.6.118:80 cookie 2 check inter 1500 rise 3 fall 3 weight 2
 
 
backend denali_server
    mode http
    balance source     #&#x8d1f;&#x8f7d;&#x5747;&#x8861;&#x7684;&#x65b9;&#x5f0f;,source&#x6839;&#x636e;&#x5ba2;&#x6237;&#x7aef;IP&#x8fdb;&#x884c;&#x54c8;&#x5e0c;&#x7684;&#x65b9;&#x5f0f;
    option allbackups  #&#x8bbe;&#x7f6e;&#x4e86;backup&#x7684;&#x65f6;&#x5019;,&#x9ed8;&#x8ba4;&#x7b2c;&#x4e00;&#x4e2a;backup&#x4f1a;&#x4f18;&#x5148;,&#x8bbe;&#x7f6e;option allbackups&#x540e;&#x6240;&#x6709;&#x5907;&#x4efd;&#x670d;&#x52a1;&#x5668;&#x6743;&#x91cd;&#x4e00;&#x6837;
 
    #&#x5fc3;&#x8df3;&#x68c0;&#x6d4b;URL&#x8bbe;&#x7f6e;
    option httpchk GET /mytaobao/home/my_taobao.jhtml HTTP/1.1\r\nHost:my.gemini.taobao.net
 
    #&#x53ef;&#x4ee5;&#x6839;&#x636e;&#x673a;&#x5668;&#x7684;&#x6027;&#x80fd;&#x4e0d;&#x540c;,&#x6307;&#x5b9a;&#x8fde;&#x63a5;&#x6570;&#x914d;&#x7f6e;&#xff0c;&#x5982;minconn 10 maxconn 20
    server denlai1 10.1.5.114:80 minconn 4 maxconn 12 check inter 1500 rise 3 fall 3
    server denlai2 10.1.6.104:80 minconn 10 maxconn 20 check inter 1500 rise 3 fall 3
    #&#x5907;&#x4efd;&#x673a;&#x5668;&#x914d;&#x7f6e;,&#x6b63;&#x5e38;&#x60c5;&#x51b5;&#x4e0b;&#x5907;&#x673a;&#x4e0d;&#x4f1a;&#x4f7f;&#x7528;,&#x5f53;&#x4e3b;&#x673a;&#x7684;&#x5168;&#x90e8;&#x670d;&#x52a1;&#x5668;&#x90fd;down&#x7684;&#x65f6;&#x5019;&#x5907;&#x673a;&#x4f1a;&#x542f;&#x7528;
    server dnali-back1 10.1.7.114:80 check backup inter 1500 rise 3 fall 3
    server dnali-back2 10.1.7.114:80 check backup inter 1500 rise 3 fall 3
 
 
backend tm_server
    mode http
    balance leastconn   #&#x8d1f;&#x8f7d;&#x5747;&#x8861;&#x7684;&#x65b9;&#x5f0f;,leastcon&#x9009;&#x62e9;&#x5f53;&#x524d;&#x8bf7;&#x6c42;&#x6570;&#x6700;&#x5c11;&#x7684;&#x670d;&#x52a1;&#x5668;
    option httpchk GET /trade/itemlist/prepayCard.htm HTTP/1.1\r\nHost:trade.gemini.taobao.net
    server tm1 10.1.5.115:80 check inter 1500 rise 3 fall 3
    server tm2 10.1.6.105:80 check inter 1500 rise 3 fall 3
 
 
#reqisetbe&#x81ea;&#x5b9a;&#x4e49;&#x5173;&#x952e;&#x5b57;&#x5339;&#x914d;backend&#x90e8;&#x5206;
backend dynamic
    mode http
    balance source
    option httpchk GET /welcome.html HTTP/1.1\r\nHost:www.taobao.net
    server denlai1 10.3.5.114:80 check inter 1500 rise 3 fall 3
    server denlai2 10.4.6.104:80 check inter 1500 rise 3 fall 3
 
backend stats
    mode http
    balance source
    option httpchk GET /welcome.html HTTP/1.1\r\nHost:www.taobao.net
    server denlai1 10.5.5.114:80 check inter 1500 rise 3 fall 3
    server denlai2 10.6.6.104:80 check inter 1500 rise 3 fall 3
</pre></div></div></div></div>
<div class="section">
<h2><a name="a4_"></a>4 &#x7528;&#x6cd5;</h2>
<div class="section">
<h3><a name="a4.1_"></a>4.1 &#x57fa;&#x672c;&#x7528;&#x6cd5;</h3></div>
<div class="section">
<h3><a name="a4.2_"></a>4.2 &#x5e38;&#x7528;&#x53c2;&#x6570;</h3></div>
<div class="section">
<h3><a name="a4.3_"></a>4.3 &#x5e38;&#x7528;&#x63d2;&#x4ef6;</h3></div>
<div class="section">
<h3><a name="a4.4_"></a>4.4 &#x793a;&#x4f8b;</h3>
<p>&#x53c2;&#x8003;&#xff1a; * <a class="externalLink" href="http://cbonte.github.io/haproxy-dconv/1.8/intro.html">HAProxy Starter Guide</a> * <a class="externalLink" href="https://baike.baidu.com/item/haproxy/5825820?fr=aladdin">&#x767e;&#x5ea6;&#x767e;&#x79d1;</a> * <a class="externalLink" href="http://xstarcd.github.io/wiki/sysadmin/haproxy_confs.html">haproxy&#x914d;&#x7f6e;&#x8303;&#x4f8b;</a></p></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2018.
          All rights reserved.    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
